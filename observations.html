<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>upkie: Observations</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">upkie<span id="projectnumber">&#160;5.2.0</span>
   </div>
   <div id="projectbrief">Open-source wheeled biped robots</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('observations.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Observations </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_docs_observations"></a> Spines compute observation dictionaries from sensor measurements by applying <em>observers</em> one after the other in a sequence called the <em>observer pipeline</em>. This page lists the outputs of available observers, using shorthands <code>a.b.c</code> for nested dictionary keys <code>observation["a"]["b"]["c"]</code>.</p>
<h1><a class="anchor" id="autotoc_md11"></a>
Inertial measurement unit</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>imu.angular_velocity</code>   </td><td class="markdownTableBodyNone"><a class="el" href="structupkie_1_1cpp_1_1actuation_1_1ImuData.html#ac8458481cd122c60f814772967ac79c1">Body angular velocity</a> of the IMU frame in [rad] / [s]    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>imu.linear_acceleration</code>   </td><td class="markdownTableBodyNone"><a class="el" href="structupkie_1_1cpp_1_1actuation_1_1ImuData.html#ae1d4bcec566f70fec66e0c1ad67724a6">Linear acceleration</a> of the IMU, with gravity filtered out, in [m] / [s]²    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>imu.orientation</code>   </td><td class="markdownTableBodyNone"><a class="el" href="structupkie_1_1cpp_1_1actuation_1_1ImuData.html#a317cd683bbf18b6df0316f1bff366ab2">Orientation of the IMU frame</a> in the <a class="el" href="observations.html#ars">ARS</a> frame as a unit quaternion (w, x, y, z)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>imu.raw_angular_velocity</code>   </td><td class="markdownTableBodyNone"><a class="el" href="structupkie_1_1cpp_1_1actuation_1_1ImuData.html#a3bd373799101951755c4e7aa5c5f3637">Raw angular velocity</a> measured by the gyroscope of the IMU, in [rad] / [s]    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>imu.raw_linear_acceleration</code>   </td><td class="markdownTableBodyNone"><a class="el" href="structupkie_1_1cpp_1_1actuation_1_1ImuData.html#afd9b3b60ed1faba74469c60853ec5588">Raw linear acceleration</a> measured by the accelerometer of the IMU, in [m] / [s]²   </td></tr>
</table>
<p >The inertial measurement unit (IMU) mounted on the <a href="https://mjbots.com/products/mjbots-pi3hat-r4-5">pi3hat</a> combines an accelerometer and a gyroscope. These raw measurements are converted onboard by an unscented Kalman filter (based on a standard quasi-static assumption) that outputs observed quantities with respect to an attitude reference system (ARS) frame.</p>
<p >Upkie spines always report <a class="el" href="structupkie_1_1cpp_1_1actuation_1_1ImuData.html">IMU observations</a>.</p>
<h2><a class="anchor" id="world-frame"></a>
World frame</h2>
<p >The world frame is an inertial frame of reference we refer to in various observers. It has an x-axis pointing forward, a y-axis pointing to the left and a z-axis vertical and pointing up (<em>i.e.</em>, against the gravity vector).</p>
<h2><a class="anchor" id="ars"></a>
Attitude reference system</h2>
<p >The attitude reference system (ARS) frame is an inertial frame of reference used by the the IMU filte. It has its x-axis pointing forward, y-axis pointing to the right and z-axis pointing down (<a href="https://github.com/mjbots/pi3hat/blob/ab632c82bd501b9fcb6f8200df0551989292b7a1/docs/reference.md#orientation">details</a>). This is not the convention we use in the world frame, and the rotation matrix from the ARS frame to the world frame is:</p>
<p >\(
R_{WA} = \begin{bmatrix}
    1 &amp; 0 &amp; 0 \\
    0 &amp; -1 &amp; 0 \\
    0 &amp; 0 &amp; -1 \\
\end{bmatrix}
\)</p>
<h1><a class="anchor" id="autotoc_md12"></a>
Servo actuators</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>servo.X</code>   </td><td class="markdownTableBodyNone">Observations for servo <code>X</code> in the servo layout    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>servo.X.position</code>   </td><td class="markdownTableBodyNone">Angle between the stator and the rotor in [rad]    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>servo.X.torque</code>   </td><td class="markdownTableBodyNone">Joint torque in [N m]    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>servo.X.velocity</code>   </td><td class="markdownTableBodyNone">Angular velocity of the rotor w.r.t. stator in rotor, in [rad] / [s]   </td></tr>
</table>
<p >Actuators on the robot are <a href="https://mjbots.com/products/qdd100-beta-3">qdd100 beta 3</a> (hips and knees) and <a href="https://mjbots.com/products/mj5208">mj5208 brushless motors</a> (wheels). All of them have <a href="https://mjbots.com/products/moteus-r4-11">moteus</a> controller boards that provide the above measurements. They are estimated as follows:</p>
<ul>
<li>Joint angle, sensed by two orthogonal Hall-effect sensors at the back of the moteus controller board (each measuring the magnetic field in one direction; the output angle is then the arc-tangent of the ratio between these two values)</li>
<li>Joint velocity, obtained by filtering joint angle measurements (not a direct measurement)</li>
<li>Joint torque, estimated from sensed phase currents (with a model that includes <a href="https://jpieper.com/2020/07/31/dealing-with-stator-magnetic-saturation/">stator magnetic saturation</a>)</li>
</ul>
<p >Upkie spines always report servo observations.</p>
<h1><a class="anchor" id="observers"></a>
Observers</h1>
<h2><a class="anchor" id="autotoc_md13"></a>
Base orientation</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>base_orientation.angular_velocity</code>   </td><td class="markdownTableBodyNone">Body angular velocity vector of the base frame in [rad] / [s]    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>base_orientation.pitch</code>   </td><td class="markdownTableBodyNone">Pitch angle of the base frame relative to the world frame, in radians   </td></tr>
</table>
<p >The <a class="el" href="classupkie_1_1cpp_1_1observers_1_1BaseOrientation.html">BaseOrientation</a> observer estimates the orientation of the floating base with respect to the world frame.</p>
<p ><img src="https://upkie.github.io/upkie/observers.png" alt="" align="right" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md14"></a>
Floor and wheel contact</h2>
<p >The <a class="el" href="classupkie_1_1cpp_1_1observers_1_1FloorContact.html">FloorContact</a> observer detects contact between the wheels and the floor. The PID balancer used for testing relies on this observer, for instance, to reset its integrator while the robot is in the air, to avoid fast-spinning wheels at touchdown.</p>
<p >Internally, the floor contact observer relies on two <a class="el" href="classupkie_1_1cpp_1_1observers_1_1WheelContact.html">WheelContact</a> observers, one for each wheel.</p>
<h2><a class="anchor" id="autotoc_md15"></a>
Wheel odometry</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>wheel_odometry.position</code>   </td><td class="markdownTableBodyNone">Ground position in [m]    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>wheel_odometry.velocity</code>   </td><td class="markdownTableBodyNone">Ground velocity in [m] / [s]   </td></tr>
</table>
<p >This observer measures the relative motion of the robot with respect to the floor, outputting ground position and velocity estimates. These quantities are used for instance in the PID balancer, which tries to stay around the same spot on the floor. Check out the <a class="el" href="classupkie_1_1cpp_1_1observers_1_1WheelOdometry.html">WheelOdometry</a> observer API for details.</p>
<h2><a class="anchor" id="history-observer"></a>
History observer</h2>
<p >The history observer reports higher-frequency signals from the spine as vectors of observations to lower-frequency agents. It handles floating-point and vector-valued observations. For instance, to report the left-knee torque readings on an Upkie, create a shared-pointer as follows and add it to the observer pipeline of the spine:</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> left_knee_torque_history = std::make_shared&lt;HistoryObserver&lt;double&gt; &gt;(</div>
<div class="line">    <span class="comment">/* keys = */</span> std::vector&lt;std::string&gt;{<span class="stringliteral">&quot;servo&quot;</span>, <span class="stringliteral">&quot;left_knee&quot;</span>, <span class="stringliteral">&quot;torque&quot;</span>},</div>
<div class="line">    <span class="comment">/* size = */</span> 10,</div>
<div class="line">    <span class="comment">/* default_value = */</span> std::numeric_limits&lt;double&gt;::quiet_NaN());</div>
<div class="line">observer_pipeline.append_observer(left_knee_torque_history);</div>
</div><!-- fragment --><p >The same syntax can be used for a vector like the IMU linear acceleration:</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> linear_acceleration_history =</div>
<div class="line">    std::make_shared&lt;HistoryObserver&lt;Eigen::Vector3d&gt; &gt;(</div>
<div class="line">        <span class="comment">/* keys = */</span> std::vector&lt;std::string&gt;{<span class="stringliteral">&quot;imu&quot;</span>, <span class="stringliteral">&quot;linear_acceleration&quot;</span>},</div>
<div class="line">        <span class="comment">/* size = */</span> 10,</div>
<div class="line">        <span class="comment">/* default_value = */</span> Eigen::Vector3d::Zero());</div>
<div class="line">observer_pipeline.append_observer(linear_acceleration_history);</div>
</div><!-- fragment --><p >Check out the <a class="el" href="classupkie_1_1cpp_1_1observers_1_1HistoryObserver.html">HistoryObserver</a> API reference for details.</p>
<h1><a class="anchor" id="autotoc_md16"></a>
Simulation</h1>
<p >Simulation spines may report additional observations:</p>
<h2><a class="anchor" id="autotoc_md17"></a>
Floating base</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>sim.base</code>   </td><td class="markdownTableBodyNone">Positions and velocities of the base frame    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>sim.base.position</code>   </td><td class="markdownTableBodyNone">Position of the base frame in the world frame, in [m]    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>sim.base.orientation</code>   </td><td class="markdownTableBodyNone">Unit quaternion (q, x, y, z) of the orientation of the base frame in the world frame    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>sim.base.linear_velocity</code>   </td><td class="markdownTableBodyNone">Linear velocity from base to world in world, in [m] / [s]    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>sim.base.angular_velocity</code>   </td><td class="markdownTableBodyNone">Angular velocity from base to world in world, in [rad] / [s]   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md18"></a>
IMU</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>sim.imu</code>   </td><td class="markdownTableBodyNone">Non-observables related to the IMU    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>sim.imu.linear_velocity</code>   </td><td class="markdownTableBodyNone">Linear velocity of the IMU frame in the world frame, in [m] / [s]   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md19"></a>
Rigid bodies</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>sim.bodies</code>   </td><td class="markdownTableBodyNone">Coordinates of rigid bodies in the world frame    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>sim.bodies.YYY</code>   </td><td class="markdownTableBodyNone">Positions and velocities of the extra body YYY    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>sim.bodies.YYY.position</code>   </td><td class="markdownTableBodyNone">Position of YYY in the world frame, in [m]    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>sim.bodies.YYY.orientation</code>   </td><td class="markdownTableBodyNone">Unit quaternion (q, x, y, z) of the orientation of YYY in the world frame   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
